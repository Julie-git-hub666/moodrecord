<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>心晴记录</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: system-ui, sans-serif; 
            background-color: #FDFBF7; 
            color: #4A4A4A; 
            height: 100dvh; 
            /* 禁止全局左右滑动 */
            overflow-x: hidden; 
        }
        .app-container {
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .scroll-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 120px;
        }
        .page { display: none; animation: fadeIn 0.2s ease; }
        .page-active { display: block !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .mood-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 3px solid transparent; }
        .mood-btn.active { transform: translateY(-6px); background-color: #fff !important; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }

        .tag-btn { transition: all 0.2s; border: 1px solid #EAE0D5; border-radius: 14px; font-size: 11px; padding: 6px 14px; background: white; color: #777; }
        .tag-btn.active { background-color: #7B8B6F; color: white; border-color: #7B8B6F; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 85px; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); border-top: 1px solid #f0f0f0; display: flex; justify-content: space-around; align-items: center; z-index: 9999; max-width: 448px; margin: 0 auto; }
        .nav-item img { width: 32px; height: 32px; filter: grayscale(1) opacity(0.2); transition: 0.3s; }
        .nav-item.tab-active img { filter: grayscale(0) opacity(1); }
        .nav-item span { font-size: 10px; color: #BBB; margin-top: 5px; font-weight: 600; }
        .nav-item.tab-active span { color: #7B8B6F; }

        /* 月历布局修正：确保不溢出 */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; width: 100%; }
        .calendar-day { aspect-ratio: 1/1.1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.6); position: relative; overflow: hidden; }
        
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 28px; border-radius: 30px; z-index: 10000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .record-card { -webkit-touch-callout: none !important; -webkit-user-select: none !important; user-select: none !important; touch-action: pan-y; }
    </style>
</head>
<body>

    <div id="toast" class="toast">记录成功 ❤️</div>

    <div class="app-container max-w-md mx-auto relative bg-[#FDFBF7]">
        <header class="p-6 pt-8 pb-0">
            <h1 class="text-2xl font-bold text-[#444]">今天过的好吗？</h1>
            <p class="text-xs text-gray-400 mt-1 mb-4">记录此刻</p>
        </header>

        <div class="scroll-area">
            <main id="inputPage" class="page page-active p-6 pt-2 space-y-6">
                <div class="grid grid-cols-5 gap-2">
                    <button onclick="selectMood(this, 'happy.png', 'pos', 5)" class="mood-btn flex flex-col items-center py-5 rounded-[2.5rem] bg-white shadow-sm">
                        <img src="happy.png" class="w-10 h-10 mb-2"><span class="text-[10px] text-gray-400 font-bold">开心</span>
                    </button>
                    <button onclick="selectMood(this, 'calm.png', 'pos', 4)" class="mood-btn flex flex-col items-center py-5 rounded-[2.5rem] bg-white shadow-sm">
                        <img src="calm.png" class="w-10 h-10 mb-2"><span class="text-[10px] text-gray-400 font-bold">平静</span>
                    </button>
                    <button onclick="selectMood(this, 'unhappy.png', 'neg', 3)" class="mood-btn flex flex-col items-center py-5 rounded-[2.5rem] bg-white shadow-sm">
                        <img src="unhappy.png" class="w-10 h-10 mb-2"><span class="text-[10px] text-gray-400 font-bold">不开心</span>
                    </button>
                    <button onclick="selectMood(this, 'anxious.png', 'neg', 2)" class="mood-btn flex flex-col items-center py-5 rounded-[2.5rem] bg-white shadow-sm">
                        <img src="anxious.png" class="w-10 h-10 mb-2"><span class="text-[10px] text-gray-400 font-bold">焦虑</span>
                    </button>
                    <button onclick="selectMood(this, 'tired.png', 'neg', 1)" class="mood-btn flex flex-col items-center py-5 rounded-[2.5rem] bg-white shadow-sm">
                        <img src="tired.png" class="w-10 h-10 mb-2"><span class="text-[10px] text-gray-400 font-bold">痛苦</span>
                    </button>
                </div>

                <div id="tagSection" class="hidden">
                    <p class="text-[10px] font-bold text-gray-300 mb-4 px-1">关键词</p>
                    <div id="tagContainer" class="flex flex-wrap gap-2"></div>
                </div>

                <textarea id="customNote" rows="4" placeholder="写点什么..." class="w-full p-6 bg-white border-none rounded-[2.5rem] shadow-sm text-sm outline-none placeholder-gray-300"></textarea>
                <button onclick="saveMood()" class="w-full bg-[#7B8B6F] text-white py-5 rounded-[2.5rem] font-bold shadow-lg text-sm tracking-widest">就这样</button>
            </main>

            <main id="listPage" class="page p-6">
                <div class="flex bg-gray-100/60 p-1 rounded-2xl mb-8">
                    <button onclick="toggleView('list')" id="v-list" class="flex-1 py-2 rounded-xl text-xs font-bold bg-white shadow-sm">时间轴</button>
                    <button onclick="toggleView('cal')" id="v-cal" class="flex-1 py-2 rounded-xl text-xs font-bold text-gray-400">月历</button>
                </div>
                <div id="listView" class="space-y-4"></div>
                <div id="calendarView" class="hidden overflow-hidden">
                    <div class="bg-white p-4 rounded-[2.5rem] shadow-sm">
                        <div class="flex justify-between items-center mb-6 font-bold text-gray-700 px-2">
                            <button onclick="changeMonth(-1)" class="p-2">‹</button>
                            <span id="calLabel">2026 / 02</span>
                            <button onclick="changeMonth(1)" class="p-2">›</button>
                        </div>
                        <div class="calendar-grid text-[10px] text-gray-300 font-bold text-center mb-4">
                            <div>周日</div><div>周一</div><div>周二</div><div>周三</div><div>周四</div><div>周五</div><div>周六</div>
                        </div>
                        <div id="calDays" class="calendar-grid"></div>
                    </div>
                </div>
            </main>

            <main id="statsPage" class="page p-6 space-y-6">
                <div class="bg-white p-7 rounded-[2.5rem] shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-800 text-sm">心情波动</h3>
                        <select id="chartRange" onchange="initChart()" class="text-[10px] bg-gray-50 p-1.5 px-3 rounded-full font-bold outline-none text-gray-500 appearance-none border-none">
                            <option value="7">最近一周</option>
                            <option value="30">最近一个月</option>
                        </select>
                    </div>
                    <div class="h-48 relative"><canvas id="moodChart"></canvas></div>
                </div>
                <div id="statsInfo" class="space-y-4 pb-10"></div>
            </main>
        </div>

        <nav class="bottom-nav">
            <button
